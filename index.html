<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kişiselleştirilmiş IPTV Player</title>
    
    <!-- PWA MANIFEST Tanımlamaları (PWABuilder için Kritik) -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="IPTVPlayer">
    <meta name="theme-color" content="#111827"> <!-- Koyu Tema -->

    <!-- Tailwind CSS (Aesthetics & Responsiveness) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Kullanıcı arayüzü ikonları) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- HLS.js (M3U8 akışlarını oynatmak için kritik kütüphane) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <!-- Firebase Kütüphaneleri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Loglama seviyesini Debug olarak ayarla
        setLogLevel('Debug');

        // Firestore ve Auth Referansları için global değişkenler
        window.fb = {
            db: null,
            auth: null,
            userId: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-iptv-app',
            isAuthReady: false
        };

        // Otomatik olarak canvas ortamından Firebase yapılandırmasını yükler
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Uygulama başlatma
        const app = initializeApp(firebaseConfig);
        fb.db = getFirestore(app);
        fb.auth = getAuth(app);

        // Kimlik doğrulama işlemi
        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(fb.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(fb.auth);
                }
            } catch (error) {
                console.error("Firebase Kimlik Doğrulama Hatası:", error);
            }
        }
        
        authenticateUser();

        // Kimlik doğrulama durumu değiştiğinde çalışır
        onAuthStateChanged(fb.auth, (user) => {
            if (user) {
                fb.userId = user.uid;
                fb.isAuthReady = true;
                console.log("Kullanıcı Kimliği:", fb.userId);
                document.getElementById('user-id-display').textContent = fb.userId;
                
                // Auth hazır olduğunda verileri yükle
                if (window.loadInitialData) {
                    window.loadInitialData();
                }
            } else {
                // Anonim oturum açılmamışsa, rastgele ID kullan (Firestore kuralları için anonim oturum açılmalı)
                fb.userId = 'unauthenticated_' + crypto.randomUUID();
                fb.isAuthReady = true;
                console.log("Anonim Kimlik Oluşturuldu (Auth bekleniyor):", fb.userId);
            }
        });

        // Global fonksiyonlar
        window.getChannelDataRef = () => doc(fb.db, "artifacts", fb.appId, "users", fb.userId, "iptv_data", "channels");
        window.getFavoritesRef = () => doc(fb.db, "artifacts", fb.appId, "users", fb.userId, "iptv_data", "favorites");
        window.getCodesRef = () => doc(fb.db, "artifacts", fb.appId, "users", fb.userId, "iptv_data", "xtream_codes");

    </script>

    <style>
        /* Genel Arka Plan ve Font */
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #e6e6e6; }
        
        /* Flexbox düzeni: Kanal listesi ve video oynatıcı yan yana */
        .container-layout {
            display: flex;
            height: 100vh;
        }

        /* Sol Panel (Liste) */
        .list-panel {
            width: 320px; /* Sabit genişlik */
            min-width: 320px;
            background-color: #161b22;
            overflow-y: auto;
            border-right: 1px solid #30363d;
            padding: 1rem;
            flex-shrink: 0;
        }

        /* Sağ Panel (Oynatıcı) */
        .player-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #0d1117;
            padding: 1rem;
        }

        /* Kanal Listesi Öğeleri */
        .channel-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #21262d;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 0.9rem;
        }
        .channel-item:hover {
            background-color: #30363d;
            transform: translateY(-1px);
        }
        .channel-item.active {
            background-color: #4a5568; 
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }

        /* Kategoriler */
        .category-button {
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* Full rounded */
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #30363d;
            color: #c9d1d9;
            transition: background-color 0.2s, color 0.2s;
            white-space: nowrap;
            font-size: 0.875rem;
        }
        .category-button:hover {
            background-color: #4a5568;
        }
        .category-button.active {
            background-color: #4f46e5; /* Indigo */
            color: white;
            font-weight: 600;
        }

        /* Video Oynatıcı */
        .video-container {
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            position: relative;
            margin-bottom: 1rem;
            background-color: #000;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Mobil Uyum */
        @media (max-width: 768px) {
            .container-layout {
                flex-direction: column;
            }
            .list-panel {
                width: 100%;
                height: 40vh; /* Mobil cihazlarda listenin bir kısmı görünür */
                min-height: 250px;
                border-right: none;
                border-bottom: 1px solid #30363d;
                order: 2; /* Listenin alta gelmesi */
            }
            .player-panel {
                order: 1; /* Oynatıcının üste gelmesi */
                height: 60vh;
                padding-bottom: 0;
            }
            .video-container {
                flex-grow: 1;
                padding-top: 0;
                height: 100%;
            }
            .video-container video {
                 object-fit: contain; /* Video'yu sığdır */
            }
        }
    </style>
</head>

<body>
    <div id="app" class="container-layout">

        <!-- Sol Panel: Kanal Listesi ve Ayarlar -->
        <div class="list-panel">
            
            <!-- Logo ve Başlık -->
            <h3 class="text-2xl font-bold text-indigo-400 mb-4 flex items-center gap-2">
                <!-- Logoyu kendi URL'nizle değiştirin! -->
                <img src="https://placehold.co/40x40/4f46e5/ffffff?text=LOGO" 
                    onerror="this.onerror=null;this.src='https://placehold.co/40x40/4f46e5/ffffff?text=LOGO';"
                    alt="Kişisel Logo" class="w-10 h-10 object-contain rounded-lg">
                
                <span class="text-white">Player Adı</span>
            </h3>
            
            <!-- Kullanıcı Kimliği -->
            <p class="text-xs text-gray-500 mb-4">
                Kullanıcı ID: <span id="user-id-display" class="font-mono text-indigo-300">Yükleniyor...</span>
            </p>

            <!-- Arama Çubuğu -->
            <input type="text" id="search-input" placeholder="Kanal Ara..." 
                   class="w-full p-2 mb-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50"
                   oninput="filterChannels()">

            <!-- Kategori Butonları -->
            <div id="category-filter" class="flex flex-wrap mb-4 overflow-x-auto pb-1">
                <!-- Kategori Butonları buraya yüklenecek -->
            </div>

            <!-- Xtream Codes Giriş Alanı -->
            <div id="xtream-codes-form" class="bg-gray-800 p-4 rounded-lg mb-4">
                <h4 class="text-lg font-semibold mb-2 text-indigo-400">Xtream Codes Girişi</h4>
                <input type="url" id="server-url" placeholder="Server URL (http://domain:port)" class="w-full p-2 mb-2 bg-gray-700 text-white rounded-lg border border-gray-600">
                <input type="text" id="username-input" placeholder="Kullanıcı Adı" class="w-full p-2 mb-2 bg-gray-700 text-white rounded-lg border border-gray-600">
                <input type="password" id="password-input" placeholder="Şifre" class="w-full p-2 mb-2 bg-gray-700 text-white rounded-lg border border-gray-600">
                <button onclick="saveXtreamCodes()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-200">
                    Giriş Yap & Verileri Kaydet
                </button>
                <div id="m3u-url-output" class="mt-2 text-sm text-green-400 hidden"></div>
            </div>

            <!-- M3U İçerik Alanı -->
            <div class="bg-gray-800 p-4 rounded-lg mb-4">
                <h4 class="text-lg font-semibold mb-2 text-indigo-400">M3U İçeriği Yapıştır</h4>
                <textarea id="m3u-input" rows="5" placeholder="Tüm M3U dosyasının içeriğini buraya yapıştırın..." 
                          class="w-full p-2 mb-2 bg-gray-700 text-white rounded-lg border border-gray-600"></textarea>
                <button onclick="parseAndSaveM3U()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-200">
                    M3U Listesini Ayrıştır & Kaydet
                </button>
            </div>
            
            <!-- Kanal Listesi -->
            <div id="channel-list" class="mt-4">
                <p id="loading-message" class="text-sm text-center text-gray-500">Kanal listesi bekleniyor...</p>
                <!-- Kanal Öğeleri buraya yüklenecek -->
            </div>
        </div>

        <!-- Sağ Panel: Video Oynatıcı -->
        <div class="player-panel">
            <h1 id="current-channel-title" class="text-xl font-semibold mb-3 text-white">Lütfen bir kanal seçin.</h1>
            
            <!-- Video Oynatıcı -->
            <div class="video-container shadow-2xl">
                <video id="video-player" controls autoplay playsinline class="w-full h-full"></video>
            </div>

            <!-- Mesaj Kutusu -->
            <div id="message-box" class="bg-yellow-800 text-yellow-200 p-3 rounded-lg hidden"></div>
        </div>

    </div>

    <script>
        // Global State
        let allChannels = [];
        let filteredChannels = [];
        let currentCategory = 'TÜMÜ';
        let currentFavorites = new Set();
        let currentVideoElement = null;
        let hlsInstance = null;
        let activeChannelId = null;

        // PWA Manifest'i dinamik olarak oluşturma (PWABuilder için)
        // PWABuilder, linkteki /manifest.json dosyasını çekmeye çalışır.
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                console.log('SW registered!', reg);
            }).catch(err => {
                console.log('SW registration failed:', err);
            });

            // Dinamik manifest içeriği
            window.addEventListener('fetch', event => {
                if (event.request.url.endsWith('/manifest.json')) {
                    event.respondWith(new Response(JSON.stringify({
                        "name": "Kişisel IPTV Player",
                        "short_name": "IPTV Player",
                        "description": "Özel IPTV Oynatıcınız",
                        "start_url": "./index.html",
                        "display": "standalone",
                        "background_color": "#111827",
                        "theme_color": "#4f46e5",
                        "icons": [
                            {"src": "https://placehold.co/192x192/4f46e5/ffffff?text=IP", "sizes": "192x192", "type": "image/png"},
                            {"src": "https://placehold.co/512x512/4f46e5/ffffff?text=IP", "sizes": "512x512", "type": "image/png"}
                        ],
                        "orientation": "portrait"
                    }), {
                        headers: { 'Content-Type': 'application/json' }
                    }));
                }
            });
        }


        // Mesaj kutusu gösterimi
        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `p-3 rounded-lg mt-4 ${type === 'error' ? 'bg-red-800 text-red-200' : 'bg-yellow-800 text-yellow-200'}`;
            box.style.display = 'block';
            setTimeout(() => {
                box.style.display = 'none';
            }, 5000);
        }

        // HLS Oynatıcıyı Başlatma
        function initializePlayer(url) {
            currentVideoElement = document.getElementById('video-player');
            
            if (hlsInstance) {
                hlsInstance.destroy(); // Önceki örneği yok et
            }

            if (Hls.isSupported()) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(url);
                hlsInstance.attachMedia(currentVideoElement);
                
                hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        showMessage(`Oynatma hatası: ${data.details}. Lütfen başka bir kanalı deneyin veya M3U URL'sini kontrol edin.`, 'error');
                        console.error('HLS Fatal Error:', data);
                    }
                });
            } else if (currentVideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                // Tarayıcı HLS'i yerel olarak destekliyorsa (iOS/Safari)
                currentVideoElement.src = url;
            } else {
                showMessage("Tarayıcınız video akışını oynatmayı desteklemiyor.", 'error');
            }

            currentVideoElement.play().catch(error => {
                 showMessage("Oynatma otomatik olarak başlatılamadı. Lütfen oynatıcıya tıklayın.", 'info');
            });
        }

        // Kanalı Oynatma
        window.playChannel = (channelId) => {
            const channel = allChannels.find(c => c.id === channelId);
            if (!channel || !channel.url) {
                showMessage("Seçilen kanalın URL'si bulunamadı.", 'error');
                return;
            }

            // Aktif kanalı işaretle
            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`channel-${channelId}`).classList.add('active');
            activeChannelId = channelId;

            document.getElementById('current-channel-title').textContent = channel.name;
            initializePlayer(channel.url);
        }

        // Favorileri Firestore'dan yükle
        async function loadFavorites() {
            if (!fb.isAuthReady) return;

            const favoritesDocRef = window.getFavoritesRef();
            const docSnap = await getDoc(favoritesDocRef);

            if (docSnap.exists() && docSnap.data().list) {
                currentFavorites = new Set(docSnap.data().list);
            } else {
                currentFavorites = new Set();
            }

            // Favori durumunu güncelle
            renderChannelList();
        }

        // Favori durumunu değiştirme ve kaydetme
        window.toggleFavorite = async (channelId, event) => {
            event.stopPropagation(); // Kanalın oynatılmasını engelle

            const channel = allChannels.find(c => c.id === channelId);
            if (!channel) return;

            const isFavorite = currentFavorites.has(channel.name);

            if (isFavorite) {
                currentFavorites.delete(channel.name);
                showMessage(`${channel.name} favorilerden çıkarıldı.`);
            } else {
                currentFavorites.add(channel.name);
                showMessage(`${channel.name} favorilere eklendi.`);
            }

            // Firestore'a kaydet
            const favoritesDocRef = window.getFavoritesRef();
            try {
                 await setDoc(favoritesDocRef, { list: Array.from(currentFavorites) }, { merge: true });
            } catch (e) {
                showMessage("Favoriler kaydedilirken hata oluştu: " + e.message, 'error');
            }

            // Listeyi yeniden render et
            renderChannelList();
            
            // Eğer aktif kategori favoriler ise, listeyi filtrele
            if (currentCategory === 'FAVORİLER') {
                 filterChannels();
            }
        };

        // M3U içeriğini ayrıştırma
        function parseM3U(m3uContent) {
            const lines = m3uContent.split('\n');
            let channels = [];
            let currentChannel = null;
            let counter = 1;

            for (const line of lines) {
                if (line.startsWith('#EXTINF:')) {
                    // Yeni kanal bilgisi
                    currentChannel = {};
                    currentChannel.id = 'ch_' + counter++;
                    currentChannel.name = (line.match(/,(.+)/) || [null, 'Bilinmeyen Kanal'])[1].trim();

                    // Grup Başlığını al
                    const groupMatch = line.match(/group-title="([^"]+)"/i);
                    currentChannel.group = groupMatch ? groupMatch[1].trim() : 'Diğer';

                } else if (currentChannel && line.startsWith('http')) {
                    // Akış URL'si
                    currentChannel.url = line.trim();
                    channels.push(currentChannel);
                    currentChannel = null;
                }
            }
            return channels;
        }

        // M3U'yu ayrıştır ve Firestore'a kaydet
        window.parseAndSaveM3U = async () => {
            if (!fb.isAuthReady) {
                showMessage("Kullanıcı kimliği yükleniyor, lütfen bekleyin.", 'info');
                return;
            }

            const m3uContent = document.getElementById('m3u-input').value.trim();
            if (!m3uContent) {
                showMessage("Lütfen M3U içeriğini yapıştırın.", 'error');
                return;
            }

            const parsedChannels = parseM3U(m3uContent);
            if (parsedChannels.length === 0) {
                showMessage("Geçerli kanal bulunamadı. Yapıştırdığınız M3U formatı doğru mu?", 'error');
                return;
            }

            try {
                // Kanal verilerini Firestore'a kaydet (JSON stringify ile)
                await setDoc(window.getChannelDataRef(), {
                    timestamp: new Date(),
                    data: JSON.stringify(parsedChannels)
                });

                showMessage(`${parsedChannels.length} kanal başarıyla ayrıştırıldı ve kaydedildi!`);
                document.getElementById('m3u-input').value = ''; // Kutuyu temizle
                
                // Kayıt sonrası veriyi tekrar yükle
                await loadInitialData(); 
            } catch (e) {
                showMessage("M3U verisi kaydedilirken hata oluştu: " + e.message, 'error');
                console.error("Firestore Kayıt Hatası:", e);
            }
        }

        // Xtream Codes'u kaydetme
        window.saveXtreamCodes = async () => {
             if (!fb.isAuthReady) {
                showMessage("Kullanıcı kimliği yükleniyor, lütfen bekleyin.", 'info');
                return;
            }
            const url = document.getElementById('server-url').value.trim();
            const user = document.getElementById('username-input').value.trim();
            const pass = document.getElementById('password-input').value.trim();

            if (!url || !user || !pass) {
                showMessage("Lütfen tüm Xtream Codes alanlarını doldurun.", 'error');
                return;
            }

            try {
                await setDoc(window.getCodesRef(), { url, user, pass });
                showMessage("Xtream Codes bilgileri başarıyla kaydedildi!");

                // M3U URL'sini göster
                const m3uUrl = `${url}/get.php?username=${user}&password=${pass}&type=m3u_plus&output=ts`;
                const outputDiv = document.getElementById('m3u-url-output');
                outputDiv.innerHTML = `M3U URL'niz: <a href="${m3uUrl}" target="_blank" class="font-bold underline">${m3uUrl}</a> <br> Lütfen bu URL'yi tarayıcınızda açıp içeriği kopyalayıp aşağıdaki kutuya yapıştırın.`;
                outputDiv.classList.remove('hidden');

            } catch (e) {
                showMessage("Xtream Codes kaydedilirken hata oluştu: " + e.message, 'error');
            }
        }

        // Xtream Codes'u yükleme
        function loadXtreamCodes() {
            onSnapshot(window.getCodesRef(), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    document.getElementById('server-url').value = data.url || '';
                    document.getElementById('username-input').value = data.user || '';
                    document.getElementById('password-input').value = data.pass || '';
                    
                    if (data.url && data.user && data.pass) {
                        const m3uUrl = `${data.url}/get.php?username=${data.user}&password=${data.pass}&type=m3u_plus&output=ts`;
                        const outputDiv = document.getElementById('m3u-url-output');
                        outputDiv.innerHTML = `M3U URL'niz: <a href="${m3uUrl}" target="_blank" class="font-bold underline">${m3uUrl}</a> <br> Bu URL'den içeriği alıp M3U alanına yapıştırın.`;
                        outputDiv.classList.remove('hidden');
                    }
                }
            });
        }


        // Kategori filtreleme
        window.setCategory = (category) => {
            currentCategory = category;
            filterChannels();
            
            // Buton aktifliğini güncelle
            document.querySelectorAll('#category-filter button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`cat-btn-${category.replace(/\s/g, '-')}`).classList.add('active');
        }

        // Kanal listesini filtreleme ve arama
        window.filterChannels = () => {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            
            // 1. Kategoriye göre filtrele
            let tempChannels;
            if (currentCategory === 'TÜMÜ') {
                tempChannels = allChannels;
            } else if (currentCategory === 'FAVORİLER') {
                tempChannels = allChannels.filter(c => currentFavorites.has(c.name));
            } else {
                tempChannels = allChannels.filter(c => c.group === currentCategory);
            }

            // 2. Arama metnine göre filtrele
            filteredChannels = tempChannels.filter(channel => 
                channel.name.toLowerCase().includes(searchText)
            );

            renderChannelList();
        }

        // Kanal Listesini HTML'e dökme
        function renderChannelList() {
            const listElement = document.getElementById('channel-list');
            listElement.innerHTML = '';
            
            if (filteredChannels.length === 0) {
                listElement.innerHTML = `<p class="text-sm text-center text-gray-500">Bu kategoride/aramada kanal bulunamadı.</p>`;
                return;
            }

            filteredChannels.forEach(channel => {
                const isFavorite = currentFavorites.has(channel.name);
                const isActive = channel.id === activeChannelId ? 'active' : '';
                const starColor = isFavorite ? 'fill-yellow-400 text-yellow-400' : 'text-gray-400';

                const html = `
                    <div id="channel-${channel.id}" class="channel-item ${isActive}" onclick="playChannel('${channel.id}')">
                        <span class="truncate pr-2">${channel.name}</span>
                        <button onclick="toggleFavorite('${channel.id}', event)" class="focus:outline-none">
                            <i data-lucide="star" class="w-5 h-5 ${starColor}"></i>
                        </button>
                    </div>
                `;
                listElement.innerHTML += html;
            });
            
            // Lucide ikonlarını tekrar render et
            lucide.createIcons();
        }

        // Kategori Butonlarını HTML'e dökme
        function renderCategoryButtons() {
            const categoryElement = document.getElementById('category-filter');
            categoryElement.innerHTML = '';
            
            const groups = allChannels.map(c => c.group);
            const uniqueGroups = ['TÜMÜ', 'FAVORİLER', ...new Set(groups)].filter(Boolean); // Tekrarsız ve boş olmayanlar

            uniqueGroups.forEach(group => {
                const isActive = group === currentCategory ? 'active' : '';
                const buttonId = `cat-btn-${group.replace(/\s/g, '-')}`;
                categoryElement.innerHTML += `
                    <button id="${buttonId}" onclick="setCategory('${group}')" class="category-button ${isActive}">
                        ${group}
                    </button>
                `;
            });
        }

        // İlk Veri Yükleme (Firestore'dan)
        window.loadInitialData = async () => {
            if (!fb.isAuthReady) return;

            document.getElementById('loading-message').style.display = 'block';

            // 1. Xtream Codes'u yükle
            loadXtreamCodes();

            // 2. Favorileri yükle
            await loadFavorites();

            // 3. Kanal verilerini yükle
            onSnapshot(window.getChannelDataRef(), (docSnapshot) => {
                document.getElementById('loading-message').style.display = 'none';

                if (docSnapshot.exists()) {
                    try {
                        const data = JSON.parse(docSnapshot.data().data);
                        allChannels = data;
                        
                        renderCategoryButtons();
                        filterChannels(); 
                        showMessage(`${allChannels.length} kanal yüklendi. Oynatmaya başlamak için bir kanal seçin.`);
                    } catch (e) {
                        showMessage("Kanal verileri yüklenirken ayrıştırma hatası oluştu.", 'error');
                        console.error("JSON Parse Hatası:", e);
                    }
                } else {
                    allChannels = [];
                    renderCategoryButtons();
                    filterChannels();
                    showMessage("Veritabanında kayıtlı kanal listeniz bulunmuyor. Lütfen M3U içeriğini yapıştırın.");
                }
            });
        }

        // Uygulama yüklendiğinde ve Auth hazır olduğunda verileri yükle
        window.onload = () => {
            lucide.createIcons();
            
            // Eğer Auth zaten hazırsa (hızlı yükleme)
            if (fb.isAuthReady) {
                window.loadInitialData();
            }
        };

    </script>
</body>
</html>

